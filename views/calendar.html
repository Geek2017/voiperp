<script src="./assets/jquery.tabletojson.min.js"></script>
<style type="text/css">
  body {
    text-align: center;
    font-size: 14px;
    font-family: "Roboto", sans-serif;
    background: url(http://www.digiphotohub.com/wp-content/uploads/2015/09/bigstock-Abstract-Blurred-Background-Of-92820527.jpg);
  }

  #clock {
    font-size: 25px;
    width: 150px;
    /* margin: 200px;  */
    text-align: center;
  }

  #wrap {
    width: 1400px;
    margin: 0 auto;
  }

  #external-events {
    float: left;
    width: 150px;
    padding: 0 10px;
    text-align: left;
  }

  #external-events h4 {
    font-size: 16px;
    margin-top: 0;
    padding-top: 1em;
  }

  .external-event {
    /* try to mimick the look of a real event */
    margin: 10px 0;
    padding: 2px 4px;
    background: #3366cc;
    color: #fff;
    font-size: 0.85em;
    cursor: pointer;
  }

  #external-events p {
    margin: 1.5em 0;
    font-size: 11px;
    color: #666;
  }

  #external-events p input {
    margin: 0;
    vertical-align: middle;
  }

  #calendar {
    /* 		float: right; */
    margin: 0 auto;
    /* width: 1100px; */
    max-width: 100%;
    height: auto;
    background-color: #ffffff;
    border-radius: 6px;
    box-shadow: 0 1px 2px #c3c3c3;
    -webkit-box-shadow: 0px 0px 21px 2px rgba(0, 0, 0, 0.18);
    -moz-box-shadow: 0px 0px 21px 2px rgba(0, 0, 0, 0.18);
    box-shadow: 0px 0px 21px 2px rgba(0, 0, 0, 0.18);
    padding: 10px;
  }

  .fc-header-title {
    color: #666;
  }

  .fc-day-header {
    color: #fff;
  }

  .fc-week {
    color: #c3c3c3;
  }

  .fc-day-number {
    width: 25px;
    height: 25px;
    text-align: center;
    line-height: 25px;
    border-radius: 100%;
    margin-top: 5px;
    margin-right: 5px;
    font-weight: 500;
  }

  .fc-day-number:hover {
    background-color: #c3c3c3;
    color: #ffffff;
  }

  thead tr th {
    background-color: #3366cc;
    padding: 10px 0 10px 0;
  }

  .fc-event-inner {
    padding: 5px;
  }

  #sw-time {
    font-size: xx-large;
    padding-left: 10px;
  }

  .my-modal .modal-content {
    background-color: black;
  }

  .pac-container {
    z-index: 10000 !important;
  }

  .refresh-btn {
    height: 26.59px;
    width: 42px;
    line-height: 32px;
    text-align: center;
    position: absolute;
    right: 157px;
    top: 10px;
    font-size: 12px;
    display: block;
    border: 1px solid;
    border-radius: 4px;
    background-color: #f5f5f5;
    border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    color: #333;
    text-shadow: 0 1px 1px rgb(255 255 255 / 75%);
    box-shadow: inset 0 1px 0 rgb(255 255 255 / 20%), 0 1px 2px rgb(0 0 0 / 5%);
  }

  .refresh-btn :hover {
    color: #333 !important;
  }
</style>

<link rel="stylesheet" type="text/css" href="/assets/css/select2.min.css" />
<link href="/assets/fullcalendar/fullcalendar/fullcalendar.css" rel="stylesheet" />
<link href="/assets/fullcalendar/fullcalendar/fullcalendar.print.css" rel="stylesheet" media="print" />
<script src="/assets/fullcalendar/fullcalendar/fullcalendar.min.js"></script>
<script src="/assets/js/select2.min.js"></script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>

<!-- <link rel="stylesheet" type="text/css" href="/assets/css/select2.min.css" /> -->
<!-- <link rel="stylesheet" type="text/css" href="/assets/css/calendar.css" /> -->
<!-- <link href="/assets/fullcalendar/fullcalendar/fullcalendar.css" rel="stylesheet" /> -->
<!-- <link href="/assets/fullcalendar/fullcalendar/fullcalendar.print.css" rel="stylesheet" media="print" /> -->
<!-- <script src="../lib/jquery.min.js"></script>
<script src="../lib/jquery-ui.custom.min.js"></script> -->
<!-- <script src="/assets/fullcalendar/fullcalendar/fullcalendar.min.js"></script> -->
<!-- <script src="/assets/js/select2.min.js"></script> -->

<!-- Select2 CSS -->
<!-- <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />  -->

<!-- jQuery -->
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>  -->

<!-- Select2 JS -->
<!-- <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script> -->
<br />

<div class="container-fluid" style="max-width: 1000px">
  <div class="row">
    <div class="col-sm-12">
      <div class="card box-shadow-title m-0">
        <div id="wrap" style="max-width: 1000px; height: auto; width: 100%">
          <img id="loadingImage" src="https://acegif.com/wp-content/uploads/loading-15.gif" alt="loading-image"
            style="width: 100%; height: 100%; border-radius: 6px" />
          <div id="refreshBtn"></div>

          <div id="calendar" style="display: none"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="myModal" role="dialog">
  <div class="modal-dialog modal-dialog-centered">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <!-- <h4 class="modal-title">Admin</h4> -->

        <button type="button" class="close" data-dismiss="modal" id="times">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <form class="" id="newEvent">
          <fieldset>
            <!-- Dropdown -->
            <!-- <select id='selUser' style='width: 200px;'>
                            <option value='0'>Select User</option>
                            <option value='1'>Yogesh singh</option>
                            <option value='2'>Sonarika Bhadoria</option>
                            <option value='3'>Anil Singh</option>
                            <option value='4'>Vishal Sahu</option>
                            <option value='5'>Mayank Patidar</option>
                            <option value='6'>Vijay Mourya</option>
                            <option value='7'>Rakesh sahu</option>
                        </select>
    
                        <input type='button' value='Seleted option' id='but_read'>
    
                        <br />
                        <div id='result'></div> -->
            <div class="row">
              <div class="col">
                <div class="form-group">
                  <!-- <label >Subject</label> -->
                  <select class="form-control" id="cleanersID" type="text" placeholder="Cleaner's Name" required
                    autocomplete="off">
                    <option value="0">Select User</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col">
                <div class="form-group">
                  <!-- <label >Subject</label> -->
                  <input class="form-control" id="title" type="text" placeholder="Title" required />
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col">
                <div class="form-group">
                  <!-- <label >Subject</label> -->
                  <input class="form-control" id="a-location" type="text" placeholder="Location" />
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col">
                <div class="form-group">
                  <!-- <label >Subject</label> -->
                  <input class="form-control" id="timeAdmin" type="time" placeholder="time" required />
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col">
                <div class="custom-file">
                  <input type="file" class="custom-file-input" id="eImages" name="eImages" required="required"
                    accept="image/*" multiple />
                  <label id="eImgLabel" class="custom-file-label text-left" style="border: none" for="eImages">Upload
                    Images</label>
                  <br /><br />
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-sm-12 d-flex">
                <ul class="fc-color-picker d-flex justify-content-around w-50" id="color-chooser">
                  <li>
                    <a class="bg-primary" onclick="pickColor('#7366ff')" style="
                        height: 25px;
                        width: 25px;
                        display: block;
                        border-radius: 3px;
                      " href="javascript:void(0)"></a>
                  </li>
                  <li>
                    <a class="bg-warning" onclick="pickColor('#f8d62b')" style="
                        height: 25px;
                        width: 25px;
                        display: block;
                        border-radius: 3px;
                      " href="javascript:void(0)"></a>
                  </li>
                  <li>
                    <a class="bg-success" onclick="pickColor('#51bb25')" style="
                        height: 25px;
                        width: 25px;
                        display: block;
                        border-radius: 3px;
                      " href="javascript:void(0)"></a>
                  </li>
                  <li>
                    <a class="bg-danger" onclick="pickColor('#dc3545')" style="
                        height: 25px;
                        width: 25px;
                        display: block;
                        border-radius: 3px;
                      " href="javascript:void(0)"></a>
                  </li>
                  <li>
                    <a class="bg-info" onclick="pickColor('#a927f9')" style="
                        height: 25px;
                        width: 25px;
                        display: block;
                        border-radius: 3px;
                      " href="javascript:void(0)"></a>
                  </li>
                </ul>
                <div class="form-group w-50">
                  <input type="color" class="p-0" id="tagColor" name="tagColor" style="width: 75%; height: 25px"
                    value="#ffffff" />
                </div>
              </div>
            </div>
            <div class="btn-group btn-group-sm pull-right">
              <button type="button" class="btn btn-success" ng-click="addtr()">
                <i class="fa fa-plus-circle"></i>
              </button>

              <button type="button" class="btn btn-danger" ng-click="removetr()">
                <i class="fa fa-minus-circle"></i>
              </button>
            </div>
            <div class="w-100 d-flex justify-content-around py-2">
              <span class="w-25 text-left" style="padding-left: 12px">Number</span>
              <span class="w-50 text-left" style="padding-left: 12px">Task</span>
              <span class="w-25">Status</span>
            </div>
            <div id="appendhere"></div>
            <div class="row mt-2">
              <div class="col">
                <div class="form-group">
                  <!-- <label >Subject</label> -->
                  <textarea class="form-control" name="aRemarks" id="aRemarks" cols="30" rows="3"
                    placeholder="Remarks"></textarea>
                </div>
              </div>
            </div>
          </fieldset>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-dismiss="modal" id="save-admin" value="Save">
          Save
        </button>
        <button type="reset" id="rstBtn" style="display: none"></button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="myModal2" role="dialog">
  <div class="modal-dialog modal-dialog-centered">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <div id="sw-time" style="display: none">00:00:00</div>
        <!-- <h4 class="modal-title">Cleaners</h4> -->
        <button type="button" class="close" data-dismiss="modal" id="times2">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <form action="" id="eUpdateEvent">
          <fieldset>
            <div class="row mb-2" id="eClock">
              <div class="col d-flex justify-content-start">
                <h6 class="px-4 py-2 m-0 w-25 text-left">Clock:</h6>
                <div id="clock" class="w-75"></div>
              </div>
            </div>
            <div class="row">
              <div class="col">
                <div class="form-group d-flex justify-content-start">
                  <h6 class="px-4 py-2 m-0 w-25 text-left">Title:</h6>
                  <input class="form-control w-75" id="c-subject" type="text" placeholder="Subject" disabled />
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col">
                <div class="form-group d-flex justify-content-start">
                  <h6 class="px-4 py-2 m-0 w-25 text-left">Location:</h6>
                  <input class="form-control w-75" id="c-location" type="text" placeholder="Location" disabled />
                </div>
              </div>
            </div>
            <div class="row" id="empUpload" style="display: none">
              <div class="col w-100 d-flex justify-content-end" style="padding-bottom: 20px">
                <h6 class="px-4 py-2 m-0 w-25 text-left">Upload:</h6>
                <div class="custom-file w-75">
                  <input type="file" class="custom-file-input" id="empImages" name="empImages" required="required"
                    accept="image/*" multiple />
                  <label id="empImgLabel" class="custom-file-label text-left" style="border: none"
                    for="empImages">Choose image</label>
                  <br /><br />
                </div>
              </div>
            </div>
            <div class="row" id="empRemark" style="display: none">
              <div class="col">
                <div class="form-group d-flex justify-content-start">
                  <h6 class="px-4 py-2 m-0 w-25 text-left">Remark:</h6>
                  <textarea class="form-control w-75" name="empRemarks" id="empRemarks" cols="30" rows="3"
                    style="resize: none" placeholder="Employee's remarks" disabled="true"></textarea>
                </div>
              </div>
            </div>
            <div class="row" id="empUploads" style="display: none">
              <div class="col">
                <div class="form-group d-flex justify-content-start">
                  <h6 class="px-4 py-2 m-0 w-25 text-left">Uploads:</h6>
                  <div id="emplUploads" class="d-flex justify-content-start flex-sm-wrap mb-2 px-2 w-75"></div>
                </div>
              </div>
            </div>
            <div class="card-body animate-chk text-left" style="display: none; padding-left: 24px" id="list">
              <h6>Tasks</h6>
              <div class="row">
                <div class="col" id="event-tasks"></div>
              </div>
            </div>
          </fieldset>
        </form>

        <!-- <p>{{gadd}}</p> -->

        <!-- <div id="sw-time">00:00:00</div> -->
      </div>
      <div class="modal-footer" id="modFoot3">
        <input type="button" value="Save" class="btn btn-success" style="display: none" id="sw-save" disabled />
        <!-- <input
          type="reset"
          value="Close"
          class="btn btn-danger ml-4"
          style="display: none"
          id="sw-rst"
          disabled
        /> -->
        <input type="button" class="btn btn-primary" value="Start" id="sw-go" disabled />
        <!-- <button type="button" class="btn btn-default" value="Reset">Start</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button> -->
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="myModal3" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <!-- <div id="sw-time" style="display: none;">00:00:00</div> -->
        <!-- <h4 class="modal-title">Cleaners</h4> -->
        <button type="button" class="btn btn-danger" id="delBtn" onclick="deleteEvent()">
          Delete
        </button>
        <button type="button" class="close" data-dismiss="modal" id="times3">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <!-- <span id="myAdd">You are @ :{{gadd}}</span> -->
        <div id="objectMap"></div>
        <fieldset>
          <div class="row">
            <div class="col">
              <div class="form-group">
                <!-- <label >Subject</label> -->
                <select class="form-control" id="emp-name" type="text" placeholder="Employee's Name" required
                  autocomplete="off"></select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <div class="form-group">
                <!-- <label >Subject</label> -->
                <input class="form-control" id="subject3" type="text" placeholder="Subject" />
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <div class="form-group">
                <!-- <label >Subject</label> -->
                <input class="form-control" id="location3" type="text" placeholder="location" />
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-sm-6 d-flex">
              <ul class="fc-color-picker d-flex justify-content-around w-50" id="color-chooser">
                <li>
                  <a class="bg-primary" onclick="pickEColor('#7366ff')" style="
                      height: 25px;
                      width: 25px;
                      display: block;
                      border-radius: 3px;
                    " href="javascript:void(0)"></a>
                </li>
                <li>
                  <a class="bg-warning" onclick="pickEColor('#f8d62b')" style="
                      height: 25px;
                      width: 25px;
                      display: block;
                      border-radius: 3px;
                    " href="javascript:void(0)"></a>
                </li>
                <li>
                  <a class="bg-success" onclick="pickEColor('#51bb25')" style="
                      height: 25px;
                      width: 25px;
                      display: block;
                      border-radius: 3px;
                    " href="javascript:void(0)"></a>
                </li>
                <li>
                  <a class="bg-danger" onclick="pickEColor('#dc3545')" style="
                      height: 25px;
                      width: 25px;
                      display: block;
                      border-radius: 3px;
                    " href="javascript:void(0)"></a>
                </li>
                <li>
                  <a class="bg-info" onclick="pickEColor('#a927f9')" style="
                      height: 25px;
                      width: 25px;
                      display: block;
                      border-radius: 3px;
                    " href="javascript:void(0)"></a>
                </li>
              </ul>
              <div class="form-group w-50 ml-1">
                <input type="color" class="p-0" id="eColor" name="eColor" style="width: 100%; height: 25px"
                  value="#ffffff" />
              </div>
            </div>
            <div class="col-sm-6">
              <div class="w-100 text-right">
                <a href="javascript:void(0)" class="py-1 px-4 bg-primary rounded mr-1" data-toggle="modal"
                  data-target="#imageModal" onclick="displayImages()">View Images</a>
              </div>
            </div>
            <div class="modal fade" id="imageModal" data-backdrop="static" data-keyboard="false" tabindex="-1"
              aria-labelledby="imageModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">
                      Event Images
                    </h5>
                    <button type="button" id="times4" class="close" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <h6 class="block text-left">Admin Photos</h6>
                    <div id="adminImages" class="d-flex justify-content-start flex-sm-wrap mb-2 px-2"></div>
                    <h6 class="block text-left">Employee Photos</h6>
                    <div id="emplImages" class="d-flex justify-content-start flex-sm-wrap mb-2 px-2"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="w-100 d-flex justify-content-around py-2">
            <span class="w-25">Number</span>
            <span class="w-50 text-left pl-2">Task</span>
            <span class="w-25">Status</span>
          </div>
          <div id="e-tasks"></div>
          <div class="row mt-3">
            <div class="col-sm-6">
              <div class="form-group">
                <label class="w-100 text-left pl-2">Remarks:</label>
                <textarea class="form-control" name="a-remarks" id="a-remarks" cols="30" rows="3"
                  placeholder="Admin remarks" style="resize: none"></textarea>
              </div>
            </div>
            <div class="col-sm-6">
              <div class="form-group">
                <label class="w-100 text-left pl-2">Employee's remarks:</label>
                <textarea class="form-control" name="eRemarks" id="eRemarks" cols="30" rows="3"
                  placeholder="Employee's remarks" style="resize: none"></textarea>
              </div>
            </div>
          </div>
        </fieldset>

        <!-- <p>{{gadd}}</p> -->

        <!-- <div id="sw-time">00:00:00</div> -->
      </div>
      <div class="modal-footer">
        <!-- <input type="button" value="Reset" style="display: none;" id="sw-rst" disabled />
                <input type="button" value="Start" id="sw-go" disabled />
                <input type="button" value="Save" style="display: none;" id="sw-save" disabled /> -->
        <!-- <button type="button" class="btn btn-default" value="Reset">Start</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button> -->
        <button type="button" class="btn btn-success" data-dismiss="modal" id="save2-admin" value="Save"
          onclick="eUpdateAdmin()">
          Save
        </button>
        <button type="reset" style="display: none"></button>
      </div>
    </div>
  </div>
</div>

<script>
  setInterval(showTime, 1000);

  function showTime() {
    let time = new Date();
    let hour = time.getHours();
    let min = time.getMinutes();
    let sec = time.getSeconds();
    am_pm = "AM";

    if (hour > 12) {
      hour -= 12;
      am_pm = "PM";
    }
    if (hour == 0) {
      hr = 12;
      am_pm = "AM";
    }

    hour = hour < 10 ? "0" + hour : hour;
    min = min < 10 ? "0" + min : min;
    sec = sec < 10 ? "0" + sec : sec;

    let currentTime = hour + ":" + min + ":" + sec + " " + am_pm;
    // document.getElementById("clock").innerHTML = currentTime;

    return currentTime;
  }

  function pickColor(color) {
    $("#tagColor").val(color);
  }

  function pickEColor(color) {
    $("#eColor").val(color);
  }

  showTime();
  var arr = [];
  var arr2 = [];
  var newFiltered = [];
  var eventTasks = [];
  var calendar;
  var comid = sessionStorage.getItem("comid");

  $(document).ready(async () => {
    document.getElementById("clock").innerHTML = showTime();
    // Initialize select2
    // $("#selUser").select2();

    // // Read selected option
    // $("#but_read").click(function () {
    //   var username = $("#selUser option:selected").text();
    //   var userid = $("#selUser").val();

    //   $("#result").html("id : " + userid + ", name : " + username);
    // });

    var date = new Date();
    var d = date.getDate();
    var m = date.getMonth();
    var y = date.getFullYear();
    var users = [];
    var data2 = [];
    var settings2 = {
      url: "https://iqq7nfcdw5.execute-api.us-east-1.amazonaws.com/fvs/allusers",
      method: "GET",
      timeout: 0,
    };

    await $.ajax(settings2)
      .done((response) => {
        var count2 = response.Count;
        for (var i = 0; i < count2; i++) {
          arr2 = {
            fullname: response.Items[i].fullname.S,
            role: response.Items[i].role.S,
            email: response.Items[i].email.S,
            comid: response.Items[i].comid.S,
          };

          data2.push(arr2);
        }
      })
      .fail((err) => {
        console.log(err);
      });

    var employee = data2.filter((user) => user.role === "ordinary" && user.comid === comid);

    for (var j = 0; j < employee.length; j++) {
      var e = employee[j];
      $("#cleanersID").append(
        `<option value="${e.email}">${e.fullname}&nbsp;&lt;${e.email}&gt;</option>`
      );
    }

    for (var j = 0; j < employee.length; j++) {
      var e = employee[j];
      $("#emp-name").append(
        `<option value="${e.email}">${e.fullname}&nbsp;&lt;${e.email}&gt;</option>`
      );
    }

    var data = [];
    var settings = {
      url: "https://iqq7nfcdw5.execute-api.us-east-1.amazonaws.com/fvs/allcalendar",
      method: "GET",
      timeout: 0,
    };

    $.ajax(settings).done(async function (response) {
      var count = response.Count;
      // console.log(response.Items[0]);
      for (var i = 0; i < count; i++) {
        var res = response.Items[i];
        arr[i] = {
          adminEmail: res.adminEmail.S,
          allDay: res.allDay.S,
          cLocation: res.cLocation.S,
          cStartingTime: res.cStartingTime.S,
          color: res.color.S,
          comid: res.comid.S,
          day: res.day.S,
          employeeEmail: res.employeeEmail.S,
          employeeName: res.employeeName.S,
          end: res.end.S,
          hr: res.hr.S,
          id: res.id.S,
          lat: res.lat.S,
          lng: res.lng.S,
          location: res.location.S,
          mins: res.mins.S,
          month: res.month.S,
          secs: res.secs.S,
          start: res.start.S,
          startingTime: res.startingTime.S,
          task: res.task.L,
          title: res.title.S,
          year: res.year.S,
          aPhoto: res.aPhoto.L,
          aRemarks: res.aRemarks.S,
          cPhoto: res.cPhoto.L,
          cRemarks: res.cRemarks.S,
          workingHr: res.workingHr.S,
        };
        data.push(arr[i]);
      }


      var role = sessionStorage.getItem("role");
      var userEmail = sessionStorage.getItem("user");
      var comidFilter = sessionStorage.getItem("comid");

      var filteredComid = arr.filter(function (user) {
        return user.comid == comidFilter;
      });

      if (role == 0) {
        newFiltered = arr.map((users) => {
          var startingTime = users.startingTime;
          var time = startingTime.split(":");
          var hr = time[0];
          var min = time[1];
          var user = {
            id: users.id,
            title: users.title,
            location: users.location,
            tasks: users.task,
            color: users.color,
            employeeEmail: users.employeeEmail,
            start: new Date(users.year, users.month, users.day, hr, min),
            end: users.end,
            allDay: false,
          };

          return user;
        });
      } else if (role == 1) {
        newFiltered = filteredComid.map((users) => {
          var startingTime = users.startingTime;
          var time = startingTime.split(":");
          var hr = time[0];
          var min = time[1];
          var user = {
            id: users.id,
            title: users.title,
            location: users.location,
            tasks: users.task,
            color: users.color,
            employeeEmail: users.employeeEmail,
            start: new Date(users.year, users.month, users.day, hr, min),
            end: users.end,
            allDay: false,
          };

          return user;
        });
      } else if (role == 2) {
        var eventFilter = arr.map((events) => {
          var startingTime = events.startingTime;
          var time = startingTime.split(":");
          var hr = time[0];
          var min = time[1];
          // console.log(hr)
          var event = {
            id: events.id,
            title: events.title,
            location: events.location,
            tasks: events.task,
            color: events.color,
            employeeEmail: events.employeeEmail,
            tasks: events.task,
            start: new Date(events.year, events.month, events.day, hr, min),
            allDay: false,
          };

          return event;
        });
        newFiltered = eventFilter.filter(
          (event) => event.employeeEmail === userEmail
        );
      }

      // console.log(arr);

      if (arr.length == 0) {
        $("#loadingImage").css("display", "block");
        $("#calendar").css("display", "none");
      } else {
        $("#calendar").css("display", "block");
        $("#loadingImage").css("display", "none");

        /* initialize the calendar
                  -----------------------------------------------------------------*/
        calendar = await $("#calendar").fullCalendar({
          header: {
            left: "title",
            center: "agendaDay,agendaWeek,month",
            right: "prev,next today",
          },
          editable: true,
          firstDay: 0, //  1(Monday) this can be changed to 0(Sunday) for the USA system
          selectable: true,
          defaultView: "month",

          axisFormat: "h:mm",
          columnFormat: {
            month: "ddd", // Mon
            week: "ddd d", // Mon 7
            day: "dddd M/d", // Monday 9/7
            agendaDay: "dddd d",
          },
          titleFormat: {
            month: "MMMM yyyy", // September 2009
            week: "MMMM yyyy", // September 2009
            day: "MMMM yyyy", // Tuesday, Sep 8, 2009
          },
          allDaySlot: false,
          selectHelper: true,
          select: function (start, end) {
            const today = Date.now();
            const strt = Date.parse(start);
            const diff = (today - strt) / 1000;
            let role = sessionStorage.getItem("role");
            if (role == 1 && diff < 86400 || role == 0 && diff < 86400) {
              $("#myModal").modal({
                backdrop: "static",
                keyboard: false
              });
              $("#save-admin").prop("disabled", false);
              const stringNew = new String(start);
              var arr1 = stringNew.split(" ");
              var fixMonth;
              var dayAdded = arr1[2] * 1;
              var dayAdded = dayAdded;
              if (arr1[1] == "Jan") {
                fixMonth = 00;
                // console.log(fixMonth);
              } else if (arr1[1] == "Feb") {
                fixMonth = 01;
                // console.log(fixMonth);
              } else if (arr1[1] == "Mar") {
                fixMonth = 02;
                // console.log(fixMonth);
              } else if (arr1[1] == "Apr") {
                fixMonth = 03;
                // console.log(fixMonth);
              } else if (arr1[1] == "May") {
                fixMonth = 04;
                // console.log(fixMonth);
              } else if (arr1[1] == "Jun") {
                fixMonth = 05;
                // console.log(fixMonth);
              } else if (arr1[1] == "Jul") {
                fixMonth = 06;
                // console.log(fixMonth);
              } else if (arr1[1] == "Aug") {
                fixMonth = 07;
                // console.log(fixMonth);
              } else if (arr1[1] == "Sep") {
                fixMonth = 08;
                // console.log(fixMonth);
              } else if (arr1[1] == "Oct") {
                fixMonth = 09;
                // console.log(fixMonth);
              } else if (arr1[1] == "Nov") {
                fixMonth = 10;
                // console.log(fixMonth);
              } else if (arr1[1] == "Dec") {
                fixMonth = 11;
                // console.log(fixMonth);
              }

              $("#save-admin").click(function () {
                var title = (document.getElementById("title").value = $(
                  "#title"
                ).val());
                var timeAdmin = document.getElementById("timeAdmin").value;
                var time = timeAdmin.split(":");
                var tagColor = $("#tagColor").val();
                var adminLocation = $("#a-location").val();
                var cleanersID = $("#cleanersID option:selected").text();
                var remarks = $("#aRemarks").val();
                var id_split = cleanersID.split("<");
                var employeeName = id_split[0];
                var employeeEmail = $("#cleanersID").val();
                var tasks = getTask();
                var userComID = sessionStorage.getItem("comid");
                var userEmail = sessionStorage.getItem("user");
                var myData2 = JSON.stringify({
                  comid: userComID,
                  task: tasks,
                  workingHr: "0",
                  startingTime: timeAdmin,
                  adminEmail: userEmail,
                  employeeName: employeeName,
                  employeeEmail: employeeEmail,
                  title: title,
                  color: tagColor,
                  aPhoto: images,
                  aRemarks: remarks,
                  location: adminLocation,
                  day: dayAdded,
                  month: fixMonth,
                  year: arr1[3],
                  start: start,
                  end: end,
                  allDay: "false",
                  hr: sessionStorage.getItem("hr"),
                  mins: sessionStorage.getItem("mins"),
                  secs: sessionStorage.getItem("secs"),
                });
                // console.log(myData2);
                calendar.fullCalendar(
                  "renderEvent", {
                    title: title,
                    start: new Date(
                      arr1[3],
                      fixMonth,
                      dayAdded,
                      time[0],
                      time[1]
                    ),
                    end: end,
                    allDay: false,
                    color: tagColor,
                  },
                  true // make the event "stick"
                );

                $.ajax({
                  type: "POST",
                  dataType: "json",
                  url: "https://iqq7nfcdw5.execute-api.us-east-1.amazonaws.com/fvs/calendar/{id}",
                  data: myData2,
                  headers: {
                    "Content-Type": "application/json",
                  },
                  success: function (data) {
                    console.log(data);
                    $("#save-admin").prop("disabled", true);
                    images = [];
                    calendar.fullCalendar("unselect");
                    console.log("Saved!");
                    // $("#times").click();
                    $("#newEvent").trigger("reset");
                    $("#appendhere .task").remove();
                    $("#myModal").modal("hide");

                    // var myData4 = JSON.stringify({
                    //   comid: myData2.comid,
                    //   adminEmail: myData2.adminEmail,
                    //   location: myData2.location,
                    //   employeeEmail: myData2.employeeEmail,
                    //   employeeName: myData2.employeeName,
                    //   color: myData2.color,
                    //   task: myData2.task,
                    //   title: myData2.title,
                    //   aPhoto: myData2.aPhoto,
                    //   aRemarks: myData2.cRemarks,
                    //   unread: "false",
                    //   createdAt: Date.now()
                    // });

                    // $.ajax({
                    //   type: "POST",
                    //   dataType: "json",
                    //   // url: "https://pq38i6wtd4.execute-api.ap-southeast-1.amazonaws.com/verkoapi/adcounts/{domain}",
                    //   url: "https://iqq7nfcdw5.execute-api.us-east-1.amazonaws.com/fvs/notifications/" +
                    //     forUpdate.id,
                    //   data: myData4,
                    //   headers: {
                    //     "Content-Type": "application/json",
                    //   },
                    //   success: function (data) {

                    //     window.location.href = "#calendar";
                    //     console.log(data);
                    //     console.log("Saved to Notifications!");


                    //   },
                    //   error: function (response) {
                    //     console.log(response);
                    //     console.log("Error");
                    //   },
                    // });
                    setTimeout(() => {
                      window.location.href = "#calendar";
                    }, 500);
                  },
                  error: function (response) {
                    console.log(response);
                    console.log("Error");
                  },
                });
              });
            } else if (role == 1 && diff > 86400) {
              calendar.fullCalendar("unselect");
            } else if (role == 2) {
              calendar.fullCalendar("unselect");
            } else {
              calendar.fullCalendar("unselect");
            }
          },
          droppable: true, // this allows things to be dropped onto the calendar !!!
          drop: function (date, allDay) {
            // this function is called when something is dropped

            // retrieve the dropped element's stored Event Object
            var originalEventObject = $(this).data("eventObject");

            // we need to copy it, so that multiple events don't have a reference to the same object
            var copiedEventObject = $.extend({}, originalEventObject);

            // assign it the date that was reported
            copiedEventObject.start = date;
            copiedEventObject.allDay = allDay;

            // render the event on the calendar
            // the last `true` argument determines if the event "sticks" (http://arshaw.com/fullcalendar/docs/event_rendering/renderEvent/)
            $("#calendar").fullCalendar("renderEvent", copiedEventObject, true);

            // is the "remove after drop" checkbox checked?
            if ($("#drop-remove").is(":checked")) {
              // if so, remove the element from the "Draggable Events" list
              $(this).remove();
            }
          },
          events: newFiltered,
        });
        $(
          "#refreshBtn"
        ).append(`<a href="javascript:void(0)" class="refresh-btn" id="refreshCalendar" onclick="refreshCalendar()"
            ><svg
              style="color: #333"
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="feather feather-refresh-cw"
            >
              <polyline points="23 4 23 10 17 10" />
              <polyline points="1 20 1 14 7 14" />
              <path
                d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
              /></svg
          ></a>`);
        checkWidth()
      }
    });

  });

  var forUpdate = {
    adminEmail: "",
    allDay: "",
    cLocation: "",
    cStartingTime: "",
    color: "",
    comid: "",
    day: "",
    employeeEmail: "",
    employeeName: "",
    end: "",
    hr: "",
    id: "",
    lat: "",
    lng: "",
    location: "",
    mins: "",
    month: "",
    secs: "",
    start: "",
    startingTime: "",
    task: [],
    title: "",
    year: "",
    aPhoto: [],
    aRemarks: "",
    cPhoto: [],
    cRemarks: "",
    workingHr: "",
  };

  var e;
  var images = [];
  var empImages = [];

  function eUpdateAdmin() {
    var cleanersID = $("#emp-name option:selected").text();
    var id_split = cleanersID.split("<");
    var employeeName = id_split[0];
    var eventId = e.id;
    var eImages = e.cPhoto.map((photo) => {
      return {
        file: photo.M.file.S,
      };
    });
    var aImages = e.aPhoto.map((photo) => {
      return {
        file: photo.M.file.S,
      };
    });
    var myData2 = JSON.stringify({
      adminEmail: e.adminEmail,
      allDay: e.allDay,
      cLocation: e.cLocation,
      cStartingTime: e.cStartingTime,
      color: $("#eColor").val(),
      comid: e.comid,
      day: e.day,
      employeeEmail: $("#emp-name").val(),
      employeeName: employeeName,
      end: e.end,
      hr: e.hr,
      id: eventId,
      lat: e.lat,
      lng: e.lat,
      location: $("#location3").val(),
      mins: e.mins,
      month: e.month,
      secs: e.secs,
      start: e.start,
      startingTime: e.startingTime,
      task: getATask(),
      title: $("#subject3").val(),
      year: e.year,
      aRemarks: $("#a-remarks").val(),
      aPhoto: aImages,
      cRemarks: $("#eRemarks").val(),
      cPhoto: eImages,
      workingHr: e.workingHr,
    });

    console.log(myData2);

    $.ajax({
      type: "DELETE",
      url: `https://iqq7nfcdw5.execute-api.us-east-1.amazonaws.com/fvs/calendar/${eventId}`,
      success: (data) => {
        console.log(data);
        $.ajax({
          type: "POST",
          dataType: "json",
          // url: "https://pq38i6wtd4.execute-api.ap-southeast-1.amazonaws.com/verkoapi/adcounts/{domain}",
          url: `https://iqq7nfcdw5.execute-api.us-east-1.amazonaws.com/fvs/calendar/${eventId}`,
          data: myData2,
          headers: {
            "Content-Type": "application/json",
          },
          success: function (data) {
            console.log(data);
            console.log("Saved!");
            window.location.href = "#calendar";
          },
          error: function (response) {
            console.log(response);
            console.log("Error");
          },
        });
      },
      error: (err) => {
        console.log(err);
      },
    });

    $("#myModal3").modal("hide");
  }

  function handleFileSelect() {
    //Check File API support
    if (window.File && window.FileList && window.FileReader) {
      var files = event.target.files; //FileList object

      for (var i = 0; i < files.length; i++) {
        if (files.length > 5) {
          alert("You can select up to 5 images only");
          $("#times").click();
        } else {
          var file = files[i];
          //Only pics
          if (!file.type.match("image")) continue;

          var picReader = new FileReader();
          picReader.addEventListener("load", function (event) {
            var picFile = event.target;
            var image = picFile.result;
            resizeImage(image, 10, 1).then((res) => {
              images.push({
                file: res
              });
            });
          });

          $("#eImgLabel").html(`Selected ${files.length} images`);
          //Read the image
          picReader.readAsDataURL(file);
        }
      }
    } else {
      console.log("Your browser does not support File API");
    }
  }

  function emphandleFileSelect() {
    //Check File API support
    if (window.File && window.FileList && window.FileReader) {
      var files = event.target.files; //FileList object

      for (var i = 0; i < files.length; i++) {
        if (files.length > 5) {
          alert("You can upload up to 5 images only");
          $("#times2").click();
        } else {
          var file = files[i];
          //Only pics
          if (!file.type.match("image")) continue;

          var picReader = new FileReader();
          picReader.addEventListener("load", function (event) {
            var picFile = event.target;
            var image = picFile.result;
            resizeImage(image, 10, 1).then((res) => {
              empImages.push({
                file: res
              });
            });
          });

          $("#empImgLabel").html(`Selected ${files.length} images`);
          //Read the image
          picReader.readAsDataURL(file);
        }
      }
    } else {
      console.log("Your browser does not support File API");
    }
  }

  async function resizeImage(dataUrl, targetFileSizeKb, maxDeviation = 1) {
    let originalFile = await urltoFile(dataUrl, "test.png", "image/png");
    if (originalFile.size / 1000 < targetFileSizeKb) return dataUrl; // File is already smaller

    let low = 0.0;
    let middle = 0.5;
    let high = 1.0;

    let result = dataUrl;

    let file = originalFile;

    while (Math.abs(file.size / 1000 - targetFileSizeKb) > maxDeviation) {
      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");
      const img = document.createElement("img");

      const promise = new Promise((resolve, reject) => {
        img.onload = () => resolve();
        img.onerror = reject;
      });

      img.src = dataUrl;

      await promise;

      canvas.width = Math.round(img.width * middle);
      canvas.height = Math.round(img.height * middle);
      context.scale(canvas.width / img.width, canvas.height / img.height);
      context.drawImage(img, 0, 0);
      file = await urltoFile(canvas.toDataURL(), "test.png", "image/png");

      if (file.size / 1000 < targetFileSizeKb - maxDeviation) {
        low = middle;
      } else if (file.size / 1000 > targetFileSizeKb) {
        high = middle;
      }

      middle = (low + high) / 2;
      result = canvas.toDataURL();
    }

    return result;
  }

  function urltoFile(url, filename, mimeType) {
    return fetch(url)
      .then(function (res) {
        return res.arrayBuffer();
      })
      .then(function (buf) {
        return new File([buf], filename, {
          type: mimeType
        });
      });
  }

  document
    .getElementById("eImages")
    .addEventListener("change", handleFileSelect, false);

  document
    .getElementById("empImages")
    .addEventListener("change", emphandleFileSelect, false);

  function getTask() {
    var tasks = [];
    var taskNames = document.querySelectorAll(".task-name");
    var taskNumber = document.querySelectorAll(".task-number");
    var taskStatus = document.querySelectorAll(".task-status");

    for (let i = 0; i < taskNames.length; i++) {
      const task = {
        number: taskNumber[i].innerHTML,
        taskItem: taskNames[i].value,
        status: taskStatus[i].checked,
      };

      tasks.push(task);
    }

    return tasks;
  }

  function getCTask() {
    var cTasks = [];
    var taskNames = document.querySelectorAll(".c-task-name");
    var taskStatus = document.querySelectorAll(".c-task-status");

    for (let i = 0; i < taskNames.length; i++) {
      const task = {
        taskItem: taskNames[i].innerHTML,
        number: i + 1,
        status: taskStatus[i].checked,
      };

      cTasks.push(task);
    }

    return cTasks;
  }

  function getATask() {
    var aTasks = [];
    var taskNames = document.querySelectorAll(".a-task-name");
    var taskNumber = document.querySelectorAll(".a-task-number");
    var taskStatus = document.querySelectorAll(".a-task-status");

    for (let i = 0; i < taskNames.length; i++) {
      const task = {
        number: taskNumber[i].innerHTML,
        taskItem: taskNames[i].value,
        status: taskStatus[i].checked,
      };

      aTasks.push(task);
    }

    return aTasks;
  }

  function swSave() {
    var usermail = sessionStorage.getItem("user");
    console.log("Save2");
    document.getElementById("sw-save").style.display = "none";
    // document.getElementById("sw-rst").style.display = "none";
    document.getElementById("sw-time").style.display = "none";
    document.getElementById("list").style.display = "none";
    var myData2 = JSON.stringify(forUpdate);


    $.ajax({
      type: "DELETE",
      url: `https://iqq7nfcdw5.execute-api.us-east-1.amazonaws.com/fvs/calendar/${forUpdate.id}`,
      success: (data) => {
        console.log(data);
        $.ajax({
          type: "POST",
          dataType: "json",
          // url: "https://pq38i6wtd4.execute-api.ap-southeast-1.amazonaws.com/verkoapi/adcounts/{domain}",
          url: "https://iqq7nfcdw5.execute-api.us-east-1.amazonaws.com/fvs/calendar/" +
            forUpdate.id,
          data: myData2,
          headers: {
            "Content-Type": "application/json",
          },
          success: function (data) {


            var settings = {
              url: "https://iqq7nfcdw5.execute-api.us-east-1.amazonaws.com/fvs/users/" + usermail,
              method: "GET",
              timeout: 0,
            };

            $.ajax(settings).done(function (response) {
              // var count = response.Count;
              var myData3 = JSON.stringify({
                email: response.email,
                comid: response.comid,
                contact: response.contact,
                designation: response.designation,
                fullname: response.fullname,
                image: response.image,
                password: response.password,
                rate: response.rate,
                role: response.role,
                verification: response.verification,
                workingHr: sessionStorage.getItem("workingHr"),
                toPay: sessionStorage.getItem("toPay")
              });

              $.ajax({
                type: "POST",
                dataType: "json",
                // url: "https://pq38i6wtd4.execute-api.ap-southeast-1.amazonaws.com/verkoapi/adcounts/{domain}",
                url: "https://iqq7nfcdw5.execute-api.us-east-1.amazonaws.com/fvs/users/" + response
                  .email,
                data: myData3,
                headers: {
                  "Content-Type": "application/json",
                },
                success: function (data) {

                  // window.location.href = "#calendar";
                  console.log(data);
                  console.log("Saved to users!");
                  // var count = response.Count;
                  var myData4 = JSON.stringify({
                    adminEmail: forUpdate.adminEmail,
                    cLocation: forUpdate.cLocation,
                    comid: forUpdate.comid,
                    employeeEmail: forUpdate.employeeEmail,
                    employeeName: forUpdate.employeeName,
                    hr: forUpdate.hr,
                    color: forUpdate.color,
                    mins: forUpdate.mins,
                    secs: forUpdate.secs,
                    task: forUpdate.task,
                    title: forUpdate.title,
                    cPhoto: forUpdate.cPhoto,
                    cRemarks: forUpdate.cRemarks,
                    unread: "false",
                    createdAt: Date.now()
                  });

                  $.ajax({
                    type: "POST",
                    dataType: "json",
                    // url: "https://pq38i6wtd4.execute-api.ap-southeast-1.amazonaws.com/verkoapi/adcounts/{domain}",
                    url: "https://iqq7nfcdw5.execute-api.us-east-1.amazonaws.com/fvs/notifications/" +
                      forUpdate.id,
                    data: myData4,
                    headers: {
                      "Content-Type": "application/json",
                    },
                    success: function (data) {

                      window.location.href = "#calendar";
                      console.log(data);
                      console.log("Saved to Notifications!");


                    },
                    error: function (response) {
                      console.log(response);
                      console.log("Error");
                    },
                  });


                },
                error: function (response) {
                  console.log(response);
                  console.log("Error");
                },
              });

            });

            // window.location.href = "#calendar";
            console.log(data);
            console.log("Saved to calendar!");


          },
          error: function (response) {
            console.log(response);
            console.log("Error");
          },
        });
      },
      error: (err) => {
        console.log(err);
      },
    });

    $("#myModal2").modal("hide");
  }

  var all = 0;
  var toAdd;

  function displayEvent(eventId) {
    const events = arr;
    sessionStorage.setItem("eventId", eventId);
    e = events.filter((event) => event.id == eventId)[0];
    // console.log(arr);
    var user = sessionStorage.getItem("user");
    var cleaner = arr.filter((c) => c.employeeEmail === user);
    // console.log(cleaner);
    for (let index = 0; index < cleaner.length; index++) {
      var hr = cleaner[index].hr * 1;
      var mn = cleaner[index].mins * 1;
      var toHr = mn / 60;
      all = all + toHr + hr;
      toAdd = all
      // console.log(all.toFixed(2));
      // console.log(hr);
      // console.log(toHr.toFixed(2));
    }

    sessionStorage.setItem("lat", e.lat);
    sessionStorage.setItem("lng", e.lng);
    const tasks = e.task;
    if (role == 1 || role == 0) {
      $("#myModal3").modal({
        backdrop: "static",
        keyboard: false
      });
      $("#eColor").val(e.color);
      $("#a-remarks").val(e.aRemarks);
      $("#eRemarks").val(e.cRemarks);
      $("#emp-name").val(e.employeeEmail);
      $("#location3").val(e.location);
      $("#subject3").val(e.title);
      if (e.lat && e.lng) {
        $("#objectMap").append(`<object
              data="./assets/geolocate2.html"
              width="100%"
              height="500"
              id="mapObj"
            ></object>`);
      }
      var eTasks = $("#e-tasks");
      for (let i = 0; i < tasks.length; i++) {
        let task = tasks[i].M;
        let c = "";
        if (task.status.S === "true") {
          c = "checked";
        } else {
          c = "";
        }
        eTasks.append(`<div class="w-100 d-flex justify-content-around py-1 eTask">
          <span class="w-25 p-2 fs-6 font-bold a-task-number">${task.number.S}</span>
          <input type="text" name="task" class="w-50 form-control a-task-name" id="task${task.number.S}" placeholder="Task #${task.number.S}" value="${task.taskItem.S}">
          <label class="input w-25 p-2 m-0">
            <input class="checkbox_animated a-task-status" type="checkbox" ${c}>
          </label>
        </div>`);
      }
      var aPhotos = e.aPhoto;
      var cLocation = $("#c-location").val();
      var aImages = aPhotos.map((photo) => {
        return {
          file: photo.M.file.S,
        };
      });
      forUpdate = {
        adminEmail: e.adminEmail,
        allDay: e.allDay,
        cLocation: cLocation,
        color: e.color,
        comid: e.comid,
        day: e.day,
        employeeEmail: e.employeeEmail,
        employeeName: e.employeeName,
        end: e.end,
        id: e.id,
        lat: lat,
        lng: lng,
        location: e.location,
        month: e.month,
        start: e.start,
        startingTime: e.startingTime,
        title: e.title,
        year: e.year,
        aRemarks: e.aRemarks,
        aPhoto: aImages,
      };
    } else {
      $("#myModal2").modal({
        backdrop: "static",
        keyboard: false
      });
      getLocation();
      sw.init();
      $("#empRemarks").val(e.cRemarks);
      $("#c-subject").val(e.title);

      var eventTasks = $("#event-tasks");
      for (let i = 0; i < tasks.length; i++) {
        let task = tasks[i].M;
        let c = "";
        if (task.status.S === "true") {
          c = "checked";
        } else {
          c = "";
        }
        eventTasks.append(`<div class="w-100 d-flex justify-content-start py-1 e-task">
          <label class="input p-2 m-0">
              <input class="checkbox_animated c-task-status" type="checkbox" name="taskcheckbox" ${c}>
          </label>
          <span class="text-left p-2 c-task-name" id="task${task.number.S}">${task.taskItem.S}</span>
        </div>`);
      }

      var empUploads = e.cPhoto;
      if (empUploads) {
        for (let a = 0; a < empUploads.length; a++) {
          const img = empUploads[a];
          $("#emplUploads").append(`<div
                          class="c-event-image d-flex align-items-center m-1 rounded p-1"
                          style="
                            width: 90px;
                            height: 90px;
                            background-color: #1d1e26;
                          "
                        >
                          <img
                            width="100%"
                            src="${img.M.file.S}"
                            alt="event-image-${a + 1}"
                          />
                        </div>`);
        }
      }

      const taskStats = tasks.map((task) => {
        return {
          status: task.M.status.S,
        };
      });

      const doneTask = taskStats.filter((task) => task.status === "true");

      for (let k = 0; k < taskStats.length; k++) {
        const t = taskStats[k];
        if (t.status === "true") {
          document.getElementById("list").style.display = "block";
          document.getElementById("empRemark").style.display = "block";
          document.getElementById("empUploads").style.display = "block";
          document.getElementById("modFoot3").style.display = "none";
          document.getElementById("eClock").style.display = "none";
        } else if (t.status === "false") {
          document.getElementById("list").style.display = "none";
          document.getElementById("empRemark").style.display = "none";
          document.getElementById("empUploads").style.display = "none";
          document.getElementById("modFoot3").style.display = "flex";
          document.getElementById("eClock").style.display = "flex";
        }
      }

      checkedTask = doneTask.length;

      $("input[name=taskcheckbox]").change(function () {
        if ($(this).is(":checked")) {
          checkedTask = checkedTask + 1;
          if (checkedTask == taskStats.length) {
            sw.ego.disabled = false;
          } else {
            sw.ego.disabled = true;
          }
        } else {
          checkedTask = checkedTask - 1;
          if (checkedTask == taskStats.length) {
            sw.ego.disabled = false;
          } else {
            sw.ego.disabled = true;
          }
        }
      });

      var aPhotos = e.aPhoto;
      var aImages = aPhotos.map((photo) => {
        return {
          file: photo.M.file.S,
        };
      });

      forUpdate = {
        adminEmail: e.adminEmail,
        allDay: e.allDay,
        cLocation: cLocation,
        color: e.color,
        comid: e.comid,
        day: e.day,
        employeeEmail: e.employeeEmail,
        employeeName: e.employeeName,
        end: e.end,
        id: e.id,
        location: e.location,
        month: e.month,
        start: e.start,
        startingTime: e.startingTime,
        title: e.title,
        year: e.year,
        aRemarks: e.aRemarks,
        aPhoto: aImages,
      };
    }
  }

  function displayImages() {
    var adminImages = e.aPhoto;
    var empImages = e.cPhoto;
    // console.log(empImages);
    if (adminImages || empImages) {
      for (let j = 0; j < adminImages.length; j++) {
        const img = adminImages[j];
        $("#adminImages").append(`<div
                          class="event-image d-flex align-items-center m-1 rounded p-1"
                          style="
                            width: 140px;
                            height: 140px;
                            background-color: #1d1e26;
                          "
                        >
                          <img
                            width="100%"
                            src="${img.M.file.S}"
                            alt="event-image-${j + 1}"
                          />
                        </div>`);
      }

      for (let i = 0; i < empImages.length; i++) {
        const eImg = empImages[i];
        $("#emplImages").append(`<div
                          class="e-event-image d-flex align-items-center m-1 rounded p-1"
                          style="
                            width: 140px;
                            height: 140px;
                            background-color: #1d1e26;
                          "
                        >
                          <img
                            width="100%"
                            src="${eImg.M.file.S}"
                            alt="e-event-image-${i + 1}"
                          />
                        </div>`);
      }
    }
  }

  function deleteEvent() {
    confirm("Delete this event?");
    const eventId = sessionStorage.getItem("eventId");
    $.ajax({
      type: "DELETE",
      url: `https://iqq7nfcdw5.execute-api.us-east-1.amazonaws.com/fvs/calendar/${eventId}`,
      success: (data) => {
        console.log(data);
        newFiltered = newFiltered.filter((item) => item.id !== eventId);
        // console.log(newFiltered);
        $(`#e-${eventId}`).remove();
        $("#times3").click();
        // window.location.href = "#calendar";
      },
      error: (err) => {
        console.log(err);
      },
    });
  }

  var lat, lng;
  var checkedTask = 0;

  function getLocation() {
    if (e.lat && e.lng) {
      $.ajax({
        url: `https://maps.googleapis.com/maps/api/geocode/json?latlng=${e.lat},${e.lng}&key=AIzaSyDENyuxiDy6R45RVnr6jhPqGM3o5cUDS1k`,
        method: "GET",
        timeout: 0,
      }).done(function (data) {
        // console.log(data);
        var results = data.results;
        $("#c-location").val(results[0].formatted_address);
      });
    } else {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };

          // console.log(pos);

          forUpdate.lat = pos.lat;
          forUpdate.lng = pos.lng;

          $.ajax({
            url: `https://maps.googleapis.com/maps/api/geocode/json?latlng=${pos.lat},${pos.lng}&key=AIzaSyDENyuxiDy6R45RVnr6jhPqGM3o5cUDS1k`,
            method: "GET",
            timeout: 0,
          }).done(function (data) {
            // console.log(data);
            var results = data.results;
            forUpdate.cLocation = results[0].formatted_address;
            $("#c-location").val(results[0].formatted_address);
          });
        });
      }
    }
  }

  function checkWidth() {
    var width = $(window).width();
    if (width <= 426) {
      console.log(width);
      $(".fc-header-left").addClass("d-block w-100");
      $(".fc-header-center").addClass("d-inline-flex w-50");
      $(".fc-header-right").addClass(
        "d-inline-flex justify-content-end w-50"
      );
      $("#refreshCalendar").css("right", "10px");
      $("#refreshCalendar").css("top", "13px");
      $("#refreshCalendar").css("width", "55.73px");
    } else {
      $(".fc-header-left").removeClass("d-block w-100");
      $(".fc-header-center").removeClass("d-inline-flex w-50");
      $(".fc-header-right").removeClass(
        "d-inline-flex justify-content-end w-50"
      );
      $("#refreshCalendar").css("right", "157px");
      $("#refreshCalendar").css("top", "10px");
    }
  }

  var width = $(window).width();

  $(window).on("resize", function () {
    if ($(this).width() !== width) {
      width = $(this).width();
      if (width <= 426) {
        // console.log(width);
        $(".fc-header-left").addClass("d-block w-100");
        $(".fc-header-center").addClass("d-inline-flex w-50");
        $(".fc-header-right").addClass(
          "d-inline-flex justify-content-end w-50"
        );
        $("#refreshCalendar").css("right", "10px");
        $("#refreshCalendar").css("top", "13px");
        $("#refreshCalendar").css("width", "55.73px");
      }
    }
    if (width > 426) {
      $(".fc-header-left").removeClass("d-block w-100");
      $(".fc-header-center").removeClass("d-inline-flex w-50");
      $(".fc-header-right").removeClass(
        "d-inline-flex justify-content-end w-50"
      );
      $("#refreshCalendar").css("right", "157px");
      $("#refreshCalendar").css("top", "10px");
    }
  });

  function refreshCalendar() {
    // console.log("clicked")
    // $("#refreshCalendar").remove()
    window.location.hash = "#/a";
    window.location.hash = "#/calendar";
  }

  // function initMap() {
  //   if (navigator.geolocation) {
  //     navigator.geolocation.getCurrentPosition(
  //       (position) => {
  //         const pos = {
  //           lat: position.coords.latitude,
  //           lng: position.coords.longitude,
  //         };

  //         const geocoder = new google.maps.Geocoder();
  //         const latlng = {
  //           lat: position.coords.latitude,
  //           lng: position.coords.longitude,
  //         };
  //         geocoder.geocode({
  //             location: latlng,
  //           },
  //           (results, status) => {
  //             if (status === "OK") {
  //               if (results[0]) {
  //                 lat = pos.lat;
  //                 lng = pos.lng;
  //                 let loc = document.getElementById("c-location");
  //                 loc.value = results[0].formatted_address;
  //               } else {
  //                 window.alert("No results found");
  //               }
  //             } else {
  //               window.alert("Geocoder failed due to: " + status);
  //             }
  //           }
  //         );
  //       },
  //       () => {
  //         handleLocationError(true, infoWindow, map.getCenter());
  //       }
  //     );
  //   } else {
  //     // Browser doesn't support Geolocation
  //     handleLocationError(false, infoWindow, map.getCenter());
  //   }
  // }

  // function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  //   infoWindow.setPosition(pos);
  //   infoWindow.setContent(
  //     browserHasGeolocation ?
  //     "Error: The Geolocation service failed." :
  //     "Error: Your browser doesn't support geolocation."
  //   );
  //   infoWindow.open(map);
  // }

  $("#times").click(function () {
    calendar.fullCalendar("unselect");
    $("#newEvent").trigger("reset");
    $("#appendhere .task").remove();
    $("#myModal").modal("hide");
    // setTimeout(() => {
    //   window.location.href = "#calendar";
    // }, 500);
  });

  $("#times3").click(function () {
    calendar.fullCalendar("unselect");
    $("#e-tasks .eTask").remove();
    $("#mapObj").remove();
    $("#myModal3").modal("hide");
    sessionStorage.removeItem("lat");
    sessionStorage.removeItem("lng");
  });

  $("#times4").click(function () {
    $("#imageModal").modal("hide");
    $("#adminImages .event-image").remove();
    $("#emplImages .e-event-image").remove();
  });

  $("#times2").click(function () {
    all = 0;
    toAdd = 0;
    forUpdate.workingHr = "0";
    // console.log(forUpdate)
    calendar.fullCalendar("unselect");
    document.getElementById("sw-time").style.display = "none";
    $("#event-tasks .e-task").remove();
    $("#emplUploads .c-event-image").remove();
    sw.reset();
    $("#myModal2").modal("hide");
  });

  var sw = {
    // (A) INITIALIZE
    etime: null, // HTML time display
    erst: null, // HTML reset button
    ego: null, // HTML start/stop button
    init: function () {
      // (A1) GET HTML ELEMENTS
      sw.etime = document.getElementById("sw-time");
      sw.ego = document.getElementById("sw-go");
      sw.esave = document.getElementById("sw-save");

      // (A2) ENABLE BUTTON CONTROLS
      sw.ego.addEventListener("click", sw.start);
      sw.ego.disabled = false;
      sw.esave.addEventListener("click", sw.save);
      sw.esave.disabled = false;
    },

    // (B) TIMER ACTION
    timer: null, // timer object
    now: 0, // current elapsed time
    tick: function () {
      // (B1) CALCULATE HOURS, MINS, SECONDS
      sw.now++;
      var remain = sw.now;
      var hours = Math.floor(remain / 3600);
      remain -= hours * 3600;
      var mins = Math.floor(remain / 60);
      remain -= mins * 60;
      var secs = remain;
      // (B2) UPDATE THE DISPLAY TIMER
      if (hours < 10) {
        hours = "0" + hours;
      }
      if (mins < 10) {
        mins = "0" + mins;
      }
      if (secs < 10) {
        secs = "0" + secs;
      }
      sw.etime.innerHTML = hours + ":" + mins + ":" + secs;
    },

    // (C) START!
    start: function () {
      forUpdate.cStartingTime = showTime();
      sw.now = 0;
      sw.timer = setInterval(sw.tick, 1000);
      sw.ego.value = "Stop";
      sw.ego.disabled = true;

      document.getElementById("sw-time").style.display = "block";
      document.getElementById("list").style.display = "block";
      document.getElementById("empUpload").style.display = "block";
      document.getElementById("empRemark").style.display = "block";
      document.getElementById("empRemarks").disabled = false;
      document.getElementById("sw-save").style.display = "none";
      sw.ego.removeEventListener("click", sw.start);
      sw.ego.addEventListener("click", sw.stop);
    },

    // (D) STOP
    stop: function () {
      var fix = 0;
      var rate = sessionStorage.getItem("rate");
      var toPay = 0;
      clearInterval(sw.timer);
      var remain = sw.now;
      var hours = Math.floor(remain / 3600);
      remain -= hours * 3600;
      var mins = Math.floor(remain / 60);
      remain -= mins * 60;
      var secs = remain;

      var minsToHr = mins / 60;
      var working = hours + minsToHr;
      fix = working + toAdd;
      toPay = rate * fix.toFixed(2);
      sessionStorage.setItem("toPay", toPay.toFixed(2));
      sessionStorage.setItem("workingHr", fix.toFixed(2));
      // console.log(working.toFixed(2));
      // console.log(toAdd.toFixed(2));

      // console.log(fix.toFixed(2));
      // console.log(toPay);

      forUpdate.hr = hours.toString();
      forUpdate.mins = mins.toString();
      forUpdate.secs = secs.toString();
      forUpdate.workingHr = fix.toFixed(2).toString();
      forUpdate.task = getCTask();
      forUpdate.cPhoto = empImages;
      forUpdate.cRemarks = $("#empRemarks").val();
      console.log(forUpdate);
      sw.timer = null;
      sw.ego.value = "Start";
      document.getElementById("sw-go").style.display = "none";
      document.getElementById("sw-save").style.display = "block";
      sw.ego.removeEventListener("click", sw.stop);
      sw.ego.addEventListener("click", sw.start);
    },

    // (E) RESET
    reset: function () {
      if (sw.timer != null) {
        sw.stop();
      }
      sw.now = 0;
      sw.tick();
      document.getElementById("sw-go").style.display = "block";
      // document.getElementById("sw-go").disabled = false;
      document.getElementById("sw-save").style.display = "none";
      document.getElementById("empUpload").style.display = "none";
      document.getElementById("empRemark").style.display = "none";
      document.getElementById("list").style.display = "none";
      checkedTask = 0;
      sw.ego.disabled = false;
    },

    save: function () {
      swSave();
    },
  };
</script>